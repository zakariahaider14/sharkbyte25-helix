name: HELIX MLOps CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1
  ARTIFACT_REGISTRY: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/helix-images

jobs:
  # ============================================================================
  # JOB 1: Run Tests
  # ============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    # Disabled: No tests directory yet
    if: false  # Enable when tests/ directory is created
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          pip install pytest pytest-cov
          pip install -r services/requirements_covid.txt
          pip install -r services/requirements_churn.txt
      
      - name: Run Python tests
        run: |
          pytest tests/ --cov=services --cov-report=xml
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Node dependencies
        run: |
          npm install -g pnpm
          pnpm install
      
      - name: Run TypeScript tests
        run: |
          pnpm test
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml

  # ============================================================================
  # JOB 2: Build and Push Docker Images
  # ============================================================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    # Removed 'needs: test' since test job is disabled
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev
      
      - name: Build COVID Service
        run: |
          docker build --platform linux/amd64 \
            -t ${{ env.ARTIFACT_REGISTRY }}/covid-service:${{ github.sha }} \
            -t ${{ env.ARTIFACT_REGISTRY }}/covid-service:latest \
            -f Dockerfile.covid .
      
      - name: Build Churn Service
        run: |
          docker build --platform linux/amd64 \
            -t ${{ env.ARTIFACT_REGISTRY }}/churn-service:${{ github.sha }} \
            -t ${{ env.ARTIFACT_REGISTRY }}/churn-service:latest \
            -f Dockerfile.churn .
      
      - name: Build Frontend
        run: |
          docker build --platform linux/amd64 \
            -t ${{ env.ARTIFACT_REGISTRY }}/helix-frontend:${{ github.sha }} \
            -t ${{ env.ARTIFACT_REGISTRY }}/helix-frontend:latest \
            -f Dockerfile.frontend .
      
      - name: Push images to Artifact Registry
        run: |
          docker push ${{ env.ARTIFACT_REGISTRY }}/covid-service:${{ github.sha }}
          docker push ${{ env.ARTIFACT_REGISTRY }}/covid-service:latest
          docker push ${{ env.ARTIFACT_REGISTRY }}/churn-service:${{ github.sha }}
          docker push ${{ env.ARTIFACT_REGISTRY }}/churn-service:latest
          docker push ${{ env.ARTIFACT_REGISTRY }}/helix-frontend:${{ github.sha }}
          docker push ${{ env.ARTIFACT_REGISTRY }}/helix-frontend:latest

  # ============================================================================
  # JOB 3: Deploy with Pulumi (Incremental Updates)
  # ============================================================================
  deploy:
    name: Deploy Infrastructure (Incremental)
    runs-on: ubuntu-latest
    needs: build
    # Manual trigger only - safe incremental updates
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Pulumi CLI
        uses: pulumi/actions@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      
      - name: Install dependencies
        run: |
          cd pulumi
          npm install
      
      - name: Select Pulumi stack
        run: |
          cd pulumi
          pulumi stack select ${{ github.event.inputs.environment || 'dev' }} --create
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
      
      - name: Preview Pulumi changes
        run: |
          cd pulumi
          pulumi preview
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
      
      - name: Deploy with Pulumi
        run: |
          cd pulumi
          pulumi up --yes
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
      
      - name: Export stack outputs
        run: |
          cd pulumi
          pulumi stack output --json > ../stack-outputs.json
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
      
      - name: Upload stack outputs
        uses: actions/upload-artifact@v3
        with:
          name: stack-outputs
          path: stack-outputs.json

  # ============================================================================
  # JOB 4: Verify Deployment
  # ============================================================================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download stack outputs
        uses: actions/download-artifact@v3
        with:
          name: stack-outputs
      
      - name: Test COVID Service
        run: |
          COVID_URL=$(jq -r '.covidServiceUrl' stack-outputs.json)
          curl -f $COVID_URL/health || exit 1
      
      - name: Test Churn Service
        run: |
          CHURN_URL=$(jq -r '.churnServiceUrl' stack-outputs.json)
          curl -f $CHURN_URL/health || exit 1
      
      - name: Test Frontend
        run: |
          FRONTEND_URL=$(jq -r '.frontendServiceUrl' stack-outputs.json)
          curl -f $FRONTEND_URL || exit 1
      
      - name: Test MLflow
        run: |
          MLFLOW_URL=$(jq -r '.mlflowServiceUrl' stack-outputs.json)
          curl -f $MLFLOW_URL/health || exit 1
      
      - name: Test Prometheus
        run: |
          PROMETHEUS_URL=$(jq -r '.prometheusServiceUrl' stack-outputs.json)
          curl -f $PROMETHEUS_URL/-/healthy || exit 1

  # ============================================================================
  # JOB 5: Notify
  # ============================================================================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [test, build, deploy, verify]
    if: always()
    
    steps:
      - name: Deployment Success
        if: ${{ needs.verify.result == 'success' }}
        run: |
          echo "✅ Deployment successful!"
          echo "Environment: ${{ github.event.inputs.environment || 'dev' }}"
          echo "Commit: ${{ github.sha }}"
      
      - name: Deployment Failed
        if: ${{ needs.verify.result == 'failure' }}
        run: |
          echo "❌ Deployment failed!"
          exit 1
